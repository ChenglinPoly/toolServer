# Tool Server v1.2 工具使用说明文档

本文档详细说明了 Tool Server v1.2 中所有可用工具的功能、参数和使用方法。所有工具的参数和行为都基于源代码中的实际实现。

## 🔧 基础API接口

### 系统状态检查
```bash
# 健康检查
curl http://localhost:8001/health

# 获取所有工具列表
curl http://localhost:8001/api/tools
```

### 任务管理API
```bash
# 创建任务（注意：task_name中的空格和中文字符需要URL编码）
curl -X POST "http://localhost:8001/api/task/create?task_id=my_task&task_name=My_Task_Name"

# 获取任务列表
curl http://localhost:8001/api/task/list

# 获取任务信息
curl http://localhost:8001/api/task/info/my_task
```

### 人类任务管理API
```bash
# 获取任务的所有人类任务
curl http://localhost:8001/api/human-tasks/my_task

# 更新人类任务状态
curl -X PUT "http://localhost:8001/api/human-tasks/my_task/human_task_id?completed=true"

# 获取单个人类任务详情
curl http://localhost:8001/api/human-tasks/my_task/human_task_id
```

### ⚠️ 重要提示

1. **中文字符处理**: 
   - 在URL参数中使用中文时必须进行URL编码
   - 建议在task_name等参数中使用英文和下划线
   - JSON请求体中的中文无需特殊处理

2. **空格处理**:
   - URL参数中的空格需要编码为`%20`或使用`+`
   - 建议使用下划线`_`或连字符`-`替代空格

3. **安全的参数示例**:
   ```bash
   # ✅ 推荐：使用英文和下划线
   curl -X POST "http://localhost:8001/api/task/create?task_id=test_task&task_name=Test_Task"
   
   # ❌ 避免：包含空格和中文
   curl -X POST "http://localhost:8001/api/task/create?task_id=测试 任务&task_name=测试 任务"
   ```

## 🚀 工具调用API

所有工具都通过统一的API接口调用：`POST /api/tool/execute`

### 基本调用格式

```bash
curl -X POST "http://localhost:8001/api/tool/execute" \
  -H "Content-Type: application/json" \
  -d '{
    "tool_name": "工具名称",
    "task_id": "任务ID", 
    "params": {
      "参数名1": "参数值1",
      "参数名2": "参数值2"
    }
  }'
```

### 实际调用示例

#### 1. 文件上传示例
```bash
curl -X POST "http://localhost:8001/api/tool/execute" \
  -H "Content-Type: application/json" \
  -d '{
    "tool_name": "file_upload",
    "task_id": "my_task",
    "params": {
      "files": [
        {
          "filename": "test.txt",
          "content": "Hello World!",
          "is_base64": false
        }
      ],
      "target_path": "upload"
    }
  }'
```

#### 2. 文件读取示例
```bash
curl -X POST "http://localhost:8001/api/tool/execute" \
  -H "Content-Type: application/json" \
  -d '{
    "tool_name": "file_read",
    "task_id": "my_task",
    "params": {
      "file_path": "upload/test.txt"
    }
  }'
```

#### 3. 人机交互示例
```bash
curl -X POST "http://localhost:8001/api/tool/execute" \
  -H "Content-Type: application/json" \
  -d '{
    "tool_name": "human_in_loop",
    "task_id": "my_task",
    "params": {
      "human_task": "Please review the uploaded file and create a summary document"
    }
  }'
```

#### 4. Google搜索示例
```bash
curl -X POST "http://localhost:8001/api/tool/execute" \
  -H "Content-Type: application/json" \
  -d '{
    "tool_name": "google_search",
    "task_id": "my_task",
    "params": {
      "query": "python machine learning tutorials",
      "num_results": 10
    }
  }'
```

### 响应格式

所有工具调用都返回统一的响应格式：

```json
{
  "success": true,
  "data": {
    // 工具执行结果
  },
  "error": null,
  "timestamp": "2025-08-15T10:05:22.963236",
  "execution_time": 1.234,
  "task_id": "my_task",
  "tool_name": "工具名称"
}
```

## 📁 文件操作工具 (file_tools.py)

### 1. file_upload - 文件上传工具

**功能描述**: 上传文件到指定目录，支持单个或多个文件上传。

**参数**:
- `files` (List[Dict], 必需): 文件列表，每个文件包含：
  - `filename` (str): 文件名
  - `content` (str): 文件内容
  - `is_base64` (bool, 可选): 是否为base64编码内容，默认False
- `target_path` (str, 可选): 目标路径，默认为'upload'

**默认行为**:
- 如果未指定`target_path`，文件将上传到任务目录的`upload`文件夹
- 支持base64编码的二进制文件上传
- 自动创建目标目录
- 返回上传文件的详细信息（路径、大小、创建时间）

### 2. file_read - 文件读取工具

**功能描述**: 读取文件内容，支持自动编码检测和行范围读取。

**参数**:
- `file_path` (str, 必需): 文件路径（相对于任务目录）
- `start_line` (int, 可选): 起始行号（从1开始）
- `end_line` (int, 可选): 结束行号（包含）
- `encoding` (str, 可选): 指定编码格式
- `silent` (bool, 可选): 静默模式，不记录详细日志

**默认行为**:
- 支持自动编码检测（utf-8, gbk, gb2312, gb18030, big5等）
- 如果不指定行范围，读取整个文件
- 返回文件内容、总行数、使用的编码等信息

### 3. file_write - 文件写入工具

**功能描述**: 写入文件内容，支持编码指定和写入模式选择。

**参数**:
- `file_path` (str, 必需): 文件路径（相对于任务目录）
- `content` (str, 可选): 文件内容，默认为空字符串
- `mode` (str, 可选): 写入模式，'overwrite'(覆盖)或'append'(追加)，默认'overwrite'
- `is_base64` (bool, 可选): 内容是否为base64编码，默认False
- `encoding` (str, 可选): 编码格式，默认'utf-8'

**默认行为**:
- 自动创建目标目录
- 覆盖模式会替换原文件内容，追加模式会在文件末尾添加内容

### 4. file_replace_lines - 文件行替换工具

**功能描述**: 替换文件中指定行范围的内容，支持自动编码检测。

**参数**:
- `file_path` (str, 必需): 文件路径
- `start_line` (int, 必需): 起始行号（从1开始）
- `end_line` (int, 必需): 结束行号（包含）
- `new_content` (str, 可选): 新内容，默认为空字符串
- `is_base64` (bool, 可选): 新内容是否为base64编码
- `encoding` (str, 可选): 指定编码格式

**默认行为**:
- 自动检测文件编码并保持原编码写回
- 如果原编码写入失败，自动回退到utf-8

### 5. file_delete - 文件删除工具

**功能描述**: 删除文件或目录。

**参数**:
- `file_path` (str, 必需): 文件或目录路径

**默认行为**:
- 文件使用`os.remove()`删除，目录使用`shutil.rmtree()`递归删除

### 6. file_move - 文件移动工具

**功能描述**: 移动文件或目录到新位置。

**参数**:
- `src_path` (str, 必需): 源路径
- `dest_path` (str, 必需): 目标路径

**默认行为**:
- 自动创建目标目录
- 使用`shutil.move()`进行移动操作

### 7. dir_create - 目录创建工具

**功能描述**: 创建目录。

**参数**:
- `dir_path` (str, 必需): 目录路径

**默认行为**:
- 使用`mkdir(parents=True, exist_ok=True)`，支持创建多级目录

### 8. dir_list - 目录列表工具

**功能描述**: 列出目录内容，支持递归和非递归模式。

**参数**:
- `dir_path` (str, 可选): 目录路径，默认为空字符串（任务根目录）
- `recursive` (bool, 可选): 是否递归列出子目录，默认False

**默认行为**:
- 非递归模式返回直接子项的列表
- 递归模式返回完整的目录树结构
- 返回文件大小、类型等信息

### 9. file_search - 文本搜索工具

**功能描述**: 在文件中搜索特定文本内容并返回匹配行。

**参数**:
- `file_path` (str, 必需): 文件路径
- `search_text` (str, 必需): 搜索文本
- `case_sensitive` (bool, 可选): 是否区分大小写，默认False
- `encoding` (str, 可选): 指定编码格式

**默认行为**:
- 支持自动编码检测
- 返回匹配行号、行内容和匹配位置

## 💻 代码执行工具 (code_tools.py)

### 1. execute_code - Python代码执行工具

**功能描述**: 执行Python代码文件。

**参数**:
- `file_path` (str, 必需): Python文件路径
- `timeout` (int, 可选): 执行超时时间（秒），默认300

**默认行为**:
- 优先使用任务的虚拟环境（`code_env/bin/python`）
- 在任务的`code_run`目录中执行
- 返回退出码、标准输出和标准错误

### 2. execute_shell - Shell命令执行工具

**功能描述**: 执行Shell命令。

**参数**:
- `command` (str, 必需): 要执行的命令
- `timeout` (int, 可选): 执行超时时间（秒），默认60
- `workdir` (str, 可选): 工作目录，默认为'code_run'

**默认行为**:
- 在指定工作目录中执行命令
- 自动创建工作目录

### 3. pip_install - Python包安装工具

**功能描述**: 在虚拟环境中安装Python包。

**参数**:
- `packages` (List[str], 必需): 要安装的包列表

**默认行为**:
- 自动创建任务虚拟环境（`code_env`）
- 如果虚拟环境不存在，会先创建
- 为每个包返回安装结果

### 4. git_clone - Git仓库克隆工具

**功能描述**: 克隆Git仓库到本地。

**参数**:
- `repo_url` (str, 必需): 仓库URL
- `target_dir` (str, 可选): 目标目录名，默认使用仓库名
- `branch` (str, 可选): 指定分支
- `token` (str, 可选): GitHub访问令牌

**默认行为**:
- 克隆到任务的`upload`目录下
- 支持GitHub私有仓库认证
- 返回仓库信息（分支、提交哈希、作者等）

### 5. parse_document - 文档解析工具

**功能描述**: 解析各种文档格式（PDF、Word、PPT、Markdown）。

**参数**:
- `file_path` (str, 必需): 文档文件路径

**支持格式**:
- PDF: 使用PyPDF2提取文本
- Word (.docx, .doc): 使用python-docx提取段落
- PowerPoint (.pptx, .ppt): 使用python-pptx提取幻灯片文本
- Markdown (.md, .markdown): 直接读取文本

**默认行为**:
- 返回文档内容和元数据（页数、段落数、字数等）

## 🌐 网络工具 (web_tools.py)

### 1. google_search - Google搜索工具

**功能描述**: 执行Google搜索并返回结果。

**参数**:
- `query` (str, 必需): 搜索查询词
- `num_results` (int, 可选): 结果数量，默认50

**默认行为**:
- 使用googlesearch-python库
- 返回标题、URL、描述等信息

### 2. crawl_page - 网页爬取工具

**功能描述**: 爬取指定URL的页面内容并转换为Markdown。

**参数**:
- `url` (str, 必需): 要爬取的URL
- `output_dir` (str, 可选): 输出目录，默认'crawled_content'
- `download_images` (bool, 可选): 是否下载图片，默认False

**默认行为**:
- 使用Crawl4AI进行页面爬取
- 输出到任务的`upload/{output_dir}`目录
- 生成固定文件名`content.md`
- 可选择下载图片到`images`子目录

### 3. google_scholar_search - Google学术搜索工具

**功能描述**: 搜索Google Scholar并保存结果。

**参数**:
- `query` (str, 必需): 搜索查询词
- `output_dir` (str, 可选): 输出目录，默认'scholar_results'
- `year_low` (int, 可选): 年份范围下限
- `year_high` (int, 可选): 年份范围上限
- `pages` (int, 可选): 搜索页数，默认1

**默认行为**:
- 输出到任务的`upload/{output_dir}`目录
- 生成基于查询词的安全文件名
- 支持多页搜索结果合并

## 🔧 高级工具 (advanced_tools.py)

### 1. tex2pdf_convert - LaTeX转PDF工具

**功能描述**: 将LaTeX文档转换为PDF。

**参数**:
- `input_path` (str, 必需): 输入目录路径（包含.tex文件）
- `output_path` (str, 可选): 输出目录路径，默认与输入目录相同
- `engine` (str, 可选): LaTeX引擎，默认'pdflatex'
- `clean_aux` (bool, 可选): 是否清理辅助文件，默认True
- `tex_filename` (str, 可选): 指定主tex文件名

**默认行为**:
- 自动查找主tex文件（优先级：指定文件 > main.tex > 包含documentclass的文件）
- 支持参考文献处理（自动运行bibtex）
- 多次编译确保引用正确
- 清理.aux、.log等辅助文件

### 2. code_task_execute - Claude Code SDK执行工具

**功能描述**: 使用Claude Code SDK执行编程任务。

**参数**:
- `prompt` (str, 必需): 任务提示
- `workspace_dir` (str, 可选): 工作目录，默认'claude_workspace'
- `api_key` (str, 可选): Anthropic API密钥
- `max_turns` (int, 可选): 最大交互轮数，默认10
- `allowed_tools` (List[str], 可选): 允许的工具列表，默认["Read", "Write", "Edit", "Bash"]
- `system_prompt` (str, 可选): 系统提示

**默认行为**:
- 自动创建任务虚拟环境
- 在指定工作目录中执行
- 返回会话信息、成本统计和文件变化

## 🔗 GitHub工具 (github_tools.py)

### 1. github_search_repositories - GitHub仓库搜索工具

**功能描述**: 搜索GitHub仓库（仅基于仓库名称）。

**参数**:
- `query` (str, 必需): 搜索关键词
- `sort` (str, 可选): 排序依据（stars, forks, updated），默认'stars'
- `order` (str, 可选): 排序顺序（asc, desc），默认'desc'
- `per_page` (int, 可选): 每页结果数，默认10，最大100
- `page` (int, 可选): 页码，默认1
- `token` (str, 可选): GitHub令牌，一定添加，不添加几乎无法响应

**默认行为**:
- 只在仓库名称中搜索（添加`in:name`限定符）
- 返回详细的仓库信息（星数、分叉数、语言、许可证等）

### 2. github_get_repository_info - GitHub仓库信息获取工具

**功能描述**: 获取指定GitHub仓库的详细信息。

**参数**:
- `full_name` (str, 必需): 仓库全名（如"owner/repo"）
- `token` (str, 可选): GitHub令牌，一定添加，不添加几乎无法响应

**默认行为**:
- 返回完整的仓库信息
- 包括统计数据、配置信息和元数据

## 👤 人机交互工具 (human_tools.py)

### 1. human_in_loop - 人机交互工具

**功能描述**: 创建人类任务并等待完成，用于需要人工干预的场景。

**参数**:
- `human_task` (str, 必需): 人类任务描述
- `timeout` (float, 可选): 超时时间（秒），None表示无限等待
- `check_interval` (float, 可选): 检查间隔（秒），默认5.0

**默认行为**:
- 创建唯一的人类任务ID
- 周期性检查任务完成状态
- 返回任务完成信息和结果

## 🔒 锁管理工具 (lock_tools.py)

### 1. file_lock - 文件锁定工具

**功能描述**: 锁定文件或目录，防止其他操作修改。

**参数**:
- `file_path` (str, 必需): 要锁定的文件或目录路径
- `level` (int, 可选): 锁等级，默认1（数字越大权限越高）
- `locker_name` (str, 必需): 上锁者名称

**默认行为**:
- 支持等级制锁定系统
- 高等级可覆盖低等级锁

### 2. file_unlock - 文件解锁工具

**功能描述**: 解锁文件或目录。

**参数**:
- `file_path` (str, 必需): 要解锁的文件或目录路径
- `unlocker_name` (str, 必需): 解锁者名称
- `unlocker_level` (int, 可选): 解锁者等级，默认1

**默认行为**:
- 高等级可无条件解锁低等级
- 同等级需要提供正确的上锁者名称

### 3. list_locks - 列出文件锁工具

**功能描述**: 列出当前文件锁状态。

**参数**:
- `filter_task_id` (str, 可选): 过滤特定任务的锁，默认为当前任务
- `show_all` (bool, 可选): 是否显示所有任务的锁，默认False

### 4. check_lock - 检查文件锁状态工具

**功能描述**: 检查特定文件或目录的锁状态。

**参数**:
- `file_path` (str, 必需): 要检查的文件或目录路径

## 🔄 代理工具 (proxy_tools.py)

### ProxyTools类

**功能描述**: 通用工具代理服务，用于代理远程工具服务器。

**初始化参数**:
- `proxy_base_url` (str): 代理服务的基础URL，默认"http://localhost:8892"
- `timeout` (float): 请求超时时间，默认120.0秒

**主要方法**:
- `discover_proxy_tools()`: 发现代理服务器上可用的工具
- `execute_proxy_tool()`: 执行代理工具
- `health_check()`: 检查代理服务器健康状态
- `get_proxy_info()`: 获取代理服务器信息

## 📋 通用规则和约定

### 路径处理
- 所有文件路径都相对于任务目录（`workspace/tasks/{task_id}/`）
- 任务目录结构：
  ```
  workspace/tasks/{task_id}/
  ├── upload/          # 文件上传默认目录
  ├── code_run/        # 代码执行目录
  ├── code_env/        # Python虚拟环境
  ├── logs/           # 日志文件
  └── ...             # 其他文件
  ```

### 错误处理
- 所有工具返回`ToolResponse`对象
- 成功时`success=True`，失败时`success=False`并包含错误信息
- 支持异步执行，避免阻塞

### 权限控制
- 读取操作使用`@require_read_access`装饰器
- 写入操作使用`@require_write_access`装饰器
- 锁管理工具使用`@bypass_lock_check`装饰器

### 编码支持
- 文件操作工具支持自动编码检测
- 优先检测中文编码（gbk, gb2312, gb18030等）
- 支持utf-8、big5、latin1等常见编码

### 超时机制
- 代码执行和Shell命令支持超时设置
- 网络请求有默认超时保护
- 人机交互支持可选超时

这个文档基于实际源代码编写，准确反映了每个工具的功能、参数和行为。建议在使用时参考此文档了解工具的具体用法和限制。 